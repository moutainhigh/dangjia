<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dangjia.acg.mapper.refund.RefundAfterSalesMapper">


    <select id="queryRefundOrderList" resultType="com.dangjia.acg.dto.refund.RefundOrderDTO">
        SELECT
            t1.storefont_id storefrontId,
            t1.id orderId,
            t1.business_order_number businessOrderNumber,
            t1.order_number orderNumber
        FROM
            dj_deliver_order t1,
            dj_deliver_order_item t2,
          dj_pay_business_order t3
        WHERE
            t1.id = t2.order_id
        and t1.business_order_number=t3.number
        and t1.payment is not NULL
        and t3.state = 3
        AND t1.house_id = #{houseId}
        AND t2.shop_count > IFNULL(t2.ask_count, 0)
        and t2.data_status = 0
        <if test="null!=searchKey and ''!=searchKey">
            AND t2.product_name LIKE CONCAT('%',#{searchKey},'%')
        </if>
        GROUP BY
            t1.storefont_id,
            t1.id,
            t1.business_order_number,
            t1.order_number
    </select>

    <select id="queryRefundOrderItemList" resultType="com.dangjia.acg.dto.refund.RefundOrderItemDTO">
        SELECT
            t.product_id productId,
            t.id orderItemId,
            t.product_name productName,
            t.product_sn productSn,
            t.product_type productType,
            t.shop_count shopCount,
            IFNULL(t.ask_count,0) askCount,
            (t.shop_count - IFNULL(t.ask_count, 0)) surplusCount,
            IFNULL(t.stevedorage_cost,0) stevedorageCost,
            IFNULL(t.transportation_cost,0) transportationCost
        FROM
            dj_deliver_order_item t
        WHERE
            t.order_id = #{orderId}
        AND t.shop_count > IFNULL(t.ask_count, 0)
        and t.data_status = 0
        <if test="null!=searchKey and ''!=searchKey">
            AND t.product_name LIKE CONCAT('%',#{searchKey},'%')
        </if>
    </select>

</mapper>