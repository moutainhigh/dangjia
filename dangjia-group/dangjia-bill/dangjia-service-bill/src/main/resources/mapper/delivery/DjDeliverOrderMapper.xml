<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dangjia.acg.mapper.delivery.DjDeliverOrderMapper">

    <select id="queryDjDeliverOrderStorefront" resultType="com.dangjia.acg.dto.delivery.OrderStorefrontDTO">
        SELECT
            t1.storefont_id storefrontId,
            t1.id orderId,
            t1.address_id addressId,
            t1.house_id houseId,
            t1.business_order_number businessOrderNumber,
            t1.order_number orderNumber,
            t4.storefront_name storefrontName
        FROM
            dj_deliver_order t1,
            dj_pay_business_order t3,
            dj_basics_storefront t4
        WHERE
            t1.business_order_number = t3.number
        AND t1.storefont_id = t4.id
        AND t1.payment IS NOT NULL
        AND t3.state = 3
        AND t1.house_id = #{houseId}
        AND EXISTS (
            SELECT
                1
            FROM
                dj_deliver_order_item t2
            WHERE
                t1.id = t2.order_id
            AND t2.shop_count > (
                IFNULL(t2.ask_count, 0) + IFNULL(t2.return_count, 0)
            )
            AND t2.data_status = 0
            AND t2.is_reservation_deliver=1
            AND (t2.reservation_deliver_time IS NULL OR t2.reservation_deliver_time='')
        )
    </select>


    <select id="queryAppointment" resultType="com.dangjia.acg.dto.delivery.AppointmentDTO">
        SELECT
            t.product_id productId,
            t.id orderItemId,
            t.storefont_id storefrontId,
            t.product_name productName,
            t.product_sn productSn,
            t.product_type productType,
            t.price price,
            IFNULL(t.image,t1.image) image,
            t.shop_count shopCount,
            IFNULL(t.ask_count,0) askCount,
            IFNULL(t.return_count,0) returnCount,
            (t.shop_count - (IFNULL(t.ask_count, 0)+IFNULL(t.return_count,0))) surplusCount,
            t1.prod_template_id productTemplateId,
            t.reservation_deliver_time as reservationDeliverTime
        FROM
            dj_deliver_order_item t,
            dj_basics_storefront_product t1
        WHERE t.product_id =t1.id
        AND t.order_id =  #{orderId}
        AND t.shop_count > (IFNULL(t.ask_count, 0)+IFNULL(t.return_count,0))
        AND t.data_status = 0
    </select>


    <select id="queryReservedStorefront" resultType="com.dangjia.acg.dto.delivery.OrderStorefrontDTO">
        SELECT
            t1.storefront_id storefrontId,
            t1.id orderSplitId,
            t1.address_id addressId,
            t1.house_id houseId,
            t4.storefront_name storefrontName,
            t1.order_id orderId
        FROM
            dj_deliver_order_split t1,
            dj_basics_storefront t4
        WHERE
            t1.storefront_id = t4.id
        AND t1.house_id=#{houseId}
        AND EXISTS (
            SELECT
                1
            FROM
                dj_deliver_order_split_item t2
            WHERE
                t1.id = t2.order_split_id
            AND t2.data_status = 0
            AND t2.is_reservation_deliver = 1
            AND t2.reservation_deliver_time IS NOT NULL
        )
    </select>


    <select id="queryReserved" resultType="com.dangjia.acg.dto.delivery.AppointmentDTO">
        SELECT
            t.product_id productId,
            t.id as orderSplitItemId,
            t.storefront_id storefrontId,
            t.product_name productName,
            t.product_sn productSn,
            t.product_type productType,
            t.price price,
            IFNULL(t.image, t1.image) image,
            IFNULL(t.ask_count, 0) askCount,
            t1.prod_template_id productTemplateId,
            t.reservation_deliver_time AS reservationDeliverTime,
            t.unit_name as unitName,
            t.order_split_id as orderSplitId
        FROM
            dj_deliver_order_split_item t,
            dj_basics_storefront_product t1
        WHERE
            t.product_id = t1.id
        AND t.data_status = 0
        AND t.order_id =  #{orderId}
    </select>

    <!--取消预约-->
    <delete id="cancelBooking">
        DELETE dj_deliver_order_split a,
         dj_deliver_order_split_item b
        FROM
            dj_deliver_order_split a,
            dj_deliver_order_split_item b
        WHERE
            a.id = b.order_split_id
        AND a.id = #{orderSplitId}
    </delete>

</mapper>