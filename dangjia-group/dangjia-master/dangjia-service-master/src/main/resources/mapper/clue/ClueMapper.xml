<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.clue.ClueMapper">

    <sql id="Clue_List">
      id,owername,phone,wechat,address,stage,
      building,number,
      label_id as labelId,
      cus_service as cusService,
      create_date as createDate,
      modify_date as modifyDate,
      data_status as dataStatus,
      remark,
      report_date as reportDate,
      member_id as memberId,
      store_id as storeId
    </sql>
    <select id="getByStage"  parameterType="int" resultType="com.dangjia.acg.modle.clue.Clue">
        SELECT
        <include refid="Clue_List" />
        FROM dj_clue where data_status=0 and stage=#{stage}
    </select>

    <select id="getByPhone"  parameterType="String" resultType="com.dangjia.acg.modle.clue.Clue">
        SELECT
        <include refid="Clue_List" />
        FROM dj_clue where data_status=0 and stage in (0,1) and phone=#{phone}
    </select>

    <select id="getAll"  resultType="com.dangjia.acg.modle.clue.Clue">
        SELECT
        <include refid="Clue_List" />
        FROM dj_clue  where data_status=0 and stage IN (0,1)
    </select>

    <select id="getAllByCondition" parameterType="String" resultType="com.dangjia.acg.modle.clue.Clue">
       select * from dj_clue
       WHERE
       data_status=0
       and stage IN (0,1)
       and CONCAT(owername,phone,wechat) like CONCAT('%',#{values},'%')

    </select>

    <select id="getGroupBy" parameterType="String" resultType="com.dangjia.acg.modle.clue.Clue">
       select
         <include refid="Clue_List" />
       from dj_clue
       WHERE
       data_status=0
       and phone=#{phone}
       <if test="null!=userId and ''!=userId">
           and cus_service=#{userId}
       </if>
    </select>

    <select id="followList" resultType="com.dangjia.acg.modle.clue.Clue">
        <if test="stage==4">
            select
            mc.member_id as memberId,
            if(m.name is not null,m.nick_name,m.name) as owername,
            m.mobile as phone,
            m.modify_date as modifyDate,
            mc.label_id_arr as labelId
            from dj_member_customer mc
            INNER JOIN dj_member m
            on mc.member_id=m.id
            where mc.data_status=0
            and mc.stage in (0,1)
            <if test="null!=userId and ''!=userId">
                and mc.user_id=#{userId}
            </if>
            <if test="null!=storeId and ''!=storeId">
                and mc.store_id=#{storeId}
            </if>
            <if test="null!=label and ''!=label">
                and label_id like CONCAT('%',#{label},'%')
            </if>
            <if test="null!=searchKey and ''!=searchKey">
                and CONCAT(m.nick_name,m.name,m.mobile) like CONCAT('%',#{searchKey},'%')
            </if>
        </if>
        <if test="stage==''">
           select
            <include refid="Clue_List" />
           from dj_clue
           WHERE
           data_status=0
           <if test="null!=label and ''!=label">
               and label_id like CONCAT('%',#{label},'%')
           </if>
           <if test="null!=searchKey and ''!=searchKey">
               and CONCAT(owername,phone) like CONCAT('%',#{searchKey},'%')
           </if>
           and stage in (0,1)
            <if test="null!=userId and ''!=userId">
                and cus_service=#{userId}
            </if>
            <if test="null!=storeId and ''!=storeId">
                and store_id=#{storeId}
            </if>
           ORDER BY create_date
           <if test="null!=time and ''!=time">
               desc
           </if>
        </if>
    </select>

    <!--客户页-->
    <select id="clientPage" resultType="com.dangjia.acg.dto.sale.client.CustomerIndexDTO">
        SELECT 
          <if test="type==0">
              c.id,owername as name,phone,c.modify_date as modifyDate
          </if>
          <if test="type==1 or type==2">
              m.id,
              if(m.name is not null,m.nick_name,m.name) as name,
              m.mobile as phone,
              m.modify_date as modifyDate,
              CONCAT(IFNULL(h.residential,'*'),IFNULL(h.building,'*栋'),IFNULL(h.unit,'*单元'),IFNULL(h.number,'*号')) as houseName
          </if>
        FROM dj_clue c
        <if test="type==0">
            WHERE c.data_status = 0 and c.stage NOT IN (2,3)
            <if test="null!=userId and ''!=userId">
                and c.cus_service=#{userId}
            </if>
            <if test="null!=storeUsers and storeUsers.size>0">
                and c.cus_service in
                <foreach collection="storeUsers" index="index" item="item" open="(" separator="," close=")">
                    #{item.storeUserId}
                </foreach>
            </if>
            ORDER BY c.modify_date desc
        </if>
        <if test="type==1">
            INNER JOIN dj_member m
            ON m.id=c.member_id
            INNER JOIN dj_house h
            ON h.member_id = m.id  and h.data_status =0 and h.visit_state =1
            WHERE m.data_status = 0
            and c.data_status = 0
            <if test="null!=userId and ''!=userId">
                and c.cus_service=#{userId}
            </if>
            <if test="null!=storeUsers and storeUsers.size>0">
                and c.cus_service in
                <foreach collection="storeUsers" index="index" item="item" open="(" separator="," close=")">
                     #{item.storeUserId}
                </foreach>
            </if>
            ORDER BY h.modify_date desc
        </if>
        <if test="type==2">
            INNER JOIN dj_member m
            ON m.id=c.member_id
            INNER JOIN dj_house h
            ON h.member_id = m.id  and h.data_status =0 and h.visit_state =3
            WHERE m.data_status = 0
            and c.data_status = 0
            <if test="null!=userId and ''!=userId">
                and c.cus_service=#{userId}
            </if>
            <if test="null!=storeUsers and storeUsers.size>0">
                and c.cus_service in
                <foreach collection="storeUsers" index="index" item="item" open="(" separator="," close=")">
                     #{item.storeUserId}
                </foreach>
            </if>
            ORDER BY h.modify_date desc
        </if>
        limit 1
    </select>

    <select id="Complete" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM  dj_clue c
        INNER JOIN dj_member_customer mc
        ON mc.member_id=c.member_id
        WHERE c.data_status = 0
        and mc.data_status = 0
        and mc.stage=4
        and c.cus_service=#{userId}
        and date_format(mc.modify_date,'%Y-%m')=#{time}
    </select>
    
    <select id="ordersCustomer" resultType="com.dangjia.acg.dto.sale.client.OrdersCustomerDTO">
        SELECT
        m.id as memberId,
        h.id as houseId,
        CONCAT(IFNULL(h.residential,'*'),IFNULL(CONCAT(h.building,'栋'),'*栋'),IFNULL(CONCAT(h.unit,'单元'),'*单元'),IFNULL(CONCAT(h.number,'号'),'*号')) as houseName,
        m.mobile,
        if(m.name is not null,m.nick_name,m.name) as name,
        h.create_date as createDate,
        h.completed_date as completedDate,
        u.username
        FROM dj_member m
        INNER JOIN dj_member_customer mc
        ON m.id=mc.member_id
        inner join dj_user u
        on mc.user_id=u.id
        INNER JOIN dj_house h
        ON mc.member_id=h.member_id
        WHERE 1=1
        <if test="null!=userId and ''!=userId">
            and mc.user_id=#{userId}
        </if>
        AND mc.stage=4
        <if test="null!=storeId and ''!=storeId">
            AND mc.store_id=#{storeId}
        </if>
        <if test="null!=staff and ''!=staff">
            AND mc.user_id=#{staff}
        </if>
        <if test="visitState==1">
            AND h.visit_state=1
        </if>
        <if test="visitState==2">
            AND h.visit_state=3
        </if>
        <if test="null!=searchKey and ''!=searchKey">
            AND CONCAT(m.name,m.mobile,h.residential,CONCAT(h.building,'栋'),CONCAT(h.unit,'单元'),CONCAT(h.number,'号')) like CONCAT('%',#{searchKey},'%')
        </if>
        <if test="visitState==1">
            ORDER BY h.create_date
        </if>
        <if test="visitState==2">
            ORDER BY h.completed_date
        </if>
        <if test="null!=time and ''!=time">
            desc
        </if>
    </select>


    <select id="sleepingCustomer" resultType="com.dangjia.acg.dto.sale.client.CustomerIndexDTO">
        select name,phone,modifyDate,createDate,labelIdArr,username from (
            SELECT
            c.owername as name,
            c.phone,
            c.modify_date AS modifyDate,
            c.create_date AS createDate,
            c.label_id AS labelIdArr,
            u.username as username
            FROM dj_clue c
            inner join dj_user u
            on c.cus_service=u.id
            WHERE (c.member_id IS NULL or c.member_id="")
            and c.stage=2
            and c.store_id=#{storeId}
            and c.data_status=0
            <if test="null!=staff and ''!=staff">
                AND c.cus_service=#{staff}
            </if>
            <if test="null!=searchKey and ''!=searchKey">
                AND CONCAT(name,phone,address) like CONCAT('%',#{searchKey},'%')
            </if>
            UNION
            SELECT
            if(m.name is not null,m.nick_name,m.name) as name,
            m.mobile AS phone,
            mc.modify_date AS modifyDate,
            mc.create_date AS createDate,
            mc.label_id_arr AS
            labelIdArr,
            u.username as username
            FROM dj_member m
            INNER JOIN dj_member_customer mc
            ON m.id=mc.member_id
            inner join dj_user u
            on mc.user_id=u.id
            WHERE mc.stage=2
            and mc.store_id=#{storeId}
            and mc.data_status=0
            <if test="null!=staff and ''!=staff">
                AND mc.user_id=#{staff}
            </if>
            <if test="null!=searchKey and ''!=searchKey">
                AND CONCAT(m.name,m.mobile) like CONCAT('%',#{searchKey},'%')
            </if>
        ) a
        order by a.modifyDate
        <if test="null!=time and ''!=time">
            desc
        </if>
    </select>


</mapper>

