<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.core.IHouseWorkerMapper">

    <sql id="all_columns">
        id,
        house_id as houseId,
        worker_id as workerId,
        worker_type_id as workerTypeId,
        worker_type as workerType,
        work_type as workType,
        is_select as isSelect,
        data_status as dataStatus,
        create_date as createDate,
        modify_date as modifyDate
    </sql>

    <!-- 根据工人id查询所有房子任务-->
    <select id="queryWorkerHouse" resultType="com.dangjia.acg.dto.core.HouseWorkerDTO">
        SELECT
        hw.id,
        hw.house_id as houseId,
        hw.worker_id as workerId,
        hw.worker_type_id as workerTypeId,
        hw.worker_type as workerType,
        hw.work_type as workType,
        hw.is_select as isSelect,
        hw.create_date as createDate,
        hw.modify_date as modifyDate,
        CONCAT(h.residential,h.building,'栋',h.unit,'单元',h.number,'号') houseName
        from `dj_core_house_worker` hw
        INNER JOIN dj_house h ON hw.house_id=h.id
        WHERE
        hw.worker_id =  #{workerId}
        and hw.work_type not in(7,2,3)
        GROUP BY hw.house_id
    </select>

    <!--根据workerTypeId和workType-->
    <select id="getByWorkerTypeId" resultType="com.dangjia.acg.modle.core.HouseWorker">
        SELECT
        <include refid="all_columns" />
        from
            dj_core_house_worker
        where
            work_type = #{workType}
        and
            worker_type_id = #{workerTypeId}
        and
            house_id = #{houseId}
    </select>

    <!-- 根据工人id查询未完工任务-->
    <select id="grabControl" resultType="com.dangjia.acg.modle.core.HouseWorker">
        SELECT
        <include refid="all_columns" />
        from
            dj_core_house_worker
        where
            worker_id = #{workerId}
        and
            worker_type &gt;3 and (work_type=1 or (work_type =6 and work_steta &lt;1))
    </select>

    <!-- 查询当天是否抢单-->
    <select id="grabOneDayOneTime" resultType="com.dangjia.acg.modle.core.HouseWorker">
        SELECT
        <include refid="all_columns" />
        from
            dj_core_house_worker
        where
            worker_type in(1,6,7)
        and worker_id = #{workerId}
        and TO_DAYS(NOW( )) - TO_DAYS(create_date) &lt;1
     </select>

    <!--根据工匠id将所有houseWorker选中状态改为0未选中 -->
    <update id="doModifyAllByWorkerId" parameterType="java.lang.String">
		update dj_core_house_worker
		set
		   is_select = 0,
		   modify_date=SYSDATE()
		where
		   worker_id =#{workerId}
	</update>

    <!--根据工人id查询已支付未完工并默认的施工任务 -->
    <select id="getDetailHouseWorker" parameterType="java.lang.String" resultType="com.dangjia.acg.modle.core.HouseWorker">
       SELECT
        <include refid="all_columns" />
        from dj_core_house_worker
        where worker_id = #{workerId}
        and work_steta in(0,1,3)
        and work_type in(1,6)
        and is_select=1
		order by modify_date desc
    </select>

    <!--根据工人id查出未整体完工的订单 -->
    <select id="getAllHouseWorker" parameterType="java.lang.String" resultType="com.dangjia.acg.modle.core.HouseWorker">
       SELECT
        <include refid="all_columns" />
        from dj_core_house_worker
        where worker_id = #{workerId}
        and work_steta in(0,1,3)
        and work_type in(1,6)
		order by modify_date desc
    </select>

    <!--根据房子id和工匠type查询houseWorker -->
    <select id="getHwByHidAndWtype"  resultType="com.dangjia.acg.modle.core.HouseWorker">
        select
        <include refid="all_columns" />
        from dj_core_house_worker
        where house_id = #{houseId}
        and worker_type = #{workerType}
        and work_type=6
        ORDER BY create_date DESC LIMIT 1
    </select>

    <!--根据工人id查询统计已完成的任务单数-->
    <select id="getCountOrderByWorkerId"  resultType="java.lang.Long">
        select count(*)
        from dj_core_house_worker
        where worker_id = #{workerId}
        and work_steta=2
        and work_type=6
		order by modify_date desc
    </select>

    <!--house已支付已采纳的普通工匠-->
    <select id="paidListByHouseId"  resultType="com.dangjia.acg.modle.core.HouseWorker">
        select  <include refid="all_columns" />
        from dj_core_house_worker
        where house_id = #{houseId}
        and worker_type not in(1,2,3)
        and work_type= 6
    </select>
</mapper>

