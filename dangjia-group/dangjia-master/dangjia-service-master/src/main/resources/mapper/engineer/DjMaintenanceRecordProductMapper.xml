<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dangjia.acg.mapper.engineer.DjMaintenanceRecordProductMapper">

    <sql id="basic_columns">
            id,
            create_date createDate,
            modify_date modifyDate,
            house_id houseId,
            product_id productId,
            maintenance_record_id maintenanceRecordId,
            shop_count shopCount,
            price,
            worker_type_id workerTypeId,
            maintenance_member_id maintenanceMemberId,
            maintenance_member_type maintenanceMemberType,
            total_price totalPrice,
            pay_price payPrice,
            over_protection over_protection,
            pay_state payState
    </sql>
    <select id="queryDjMaintenanceRecordProductList"
            resultType="com.dangjia.acg.dto.engineer.DjMaintenanceRecordProductDTO">
        SELECT
            mrp.id,
            mrp.product_id productId,
            bsp.product_name productName,
            mrp.shop_count shopCount,
            (
                mrp.shop_count * bsp.sell_price
            ) totalPrice,
            bsp.image,
            bpt.value_id_arr as valueIdArr
        FROM
            dj_maintenance_record_product mrp,
            dj_basics_storefront_product bsp,
            dj_basics_product_template bpt
        WHERE
            mrp.product_id = bsp.id and bsp.prod_template_id = bpt.id
            AND mrp.maintenance_record_id=#{maintenanceRecordId}
    </select>

    <select id="queryGroupByGoodsCategory" resultType="com.dangjia.acg.modle.product.BasicsGoodsCategory">
        SELECT
            bgc1.id,
            bgc1.name
        FROM
            dj_maintenance_record_product mrp
        INNER JOIN dj_basics_storefront_product bsp ON mrp.product_id = bsp.id
        INNER JOIN dj_basics_product_template bpt ON bsp.prod_template_id = bpt.id
        INNER JOIN dj_basics_goods_category bgc ON bgc.id = bpt.category_id
        INNER JOIN dj_basics_goods_category bgc1 ON bgc1.id = bgc.parent_top
        WHERE 1=1
        <if test="null!=maintenanceMemberId and ''!=maintenanceMemberId">
            mrp.maintenance_member_id =#{maintenanceMemberId}
        </if>
        <if test="null!=maintenanceMemberType and ''!=maintenanceMemberType">
            AND mrp.maintenance_member_type =#{maintenanceMemberType}
        </if>
        <if test="null!=maintenanceRecordId and ''!=maintenanceRecordId">
            AND mrp.maintenance_record_id =#{maintenanceRecordId}
        </if>
        <if test="null!=houseId and ''!=houseId">
            AND mrp.house_id =#{houseId}
        </if>
        AND mrp.data_status = 0
        GROUP BY bgc1.name,bgc1.id
    </select>

    <select id="queryMaintenanceShoppingBasket" resultType="com.dangjia.acg.dto.engineer.DjMaintenanceRecordProductDTO">
        SELECT
            mrp.id,
            bsp.product_name productName,
            bsp.image,
            bsp.sell_price sellPrice,
            bsp.prod_template_id prodTemplateId,
            bsp.id storefrontProductId
        FROM
            dj_maintenance_record_product mrp
        INNER JOIN dj_basics_storefront_product bsp ON mrp.product_id = bsp.id
        INNER JOIN dj_basics_product_template bpt ON bsp.prod_template_id = bpt.id
        INNER JOIN dj_basics_goods_category bgc ON bgc.id = bpt.category_id
        WHERE
            bgc.parent_top =#{parentTop}
    </select>

    <select id="selectMaintenanceProductByMemberId" resultType="com.dangjia.acg.modle.engineer.DjMaintenanceRecordProduct">
        SELECT
        <include refid="basic_columns"/>
        FROM
            dj_maintenance_record_product mrp
        WHERE
            mrp.maintenance_member_id = #{memberId}
        AND mrp.house_id = #{houseId}
        and mrp.maintenance_member_type = #{maintenanceRecordType}
        and mrp.worker_type_id = #{workerTypeId}
        AND (
            mrp.maintenance_record_id IS NULL
            OR maintenance_record_id = ''
        )
    </select>

    <select id="selectWorkerTypeListById" resultType="java.util.Map">
       SELECT
            mrp.worker_type_id workerTypeId,
            cwt.`name` workerTypeName,
            cwt.image workerTypeImage,
            mrp.over_protection overProtection,
            sum(mrp.total_price) totalPrice,
            sum(mrp.pay_price) payPrice
        FROM
            dj_maintenance_record_product mrp,
            dj_core_worker_type cwt
        WHERE
            mrp.worker_type_id = cwt.id
        AND mrp.maintenance_record_id = #{maintenanceRecordId}
        AND mrp.maintenance_member_type = #{maintenanceRecordType}
        and mrp.pay_state = 1
        group by mrp.worker_type_id,cwt.`name`,cwt.image
    </select>

    <!-- 查询已支付的商品总价 -->
    <select id="queryMaintenanceRecordMoney" resultType="java.lang.Double">
        SELECT
            sum(mrp.pay_price) payPrice
        FROM
            dj_maintenance_record_product mrp
        WHERE
            mrp.maintenance_record_id = #{maintenanceRecordId}
        AND mrp.maintenance_member_type = #{maintenanceRecordType}
        AND mrp.pay_state = 2
    </select>

    <select id="queryPayMaintenanceRecordProduct" resultType="com.dangjia.acg.modle.engineer.DjMaintenanceRecordProduct">
        SELECT
        <include refid="basic_columns"/>
        FROM
        dj_maintenance_record_product mrp
        WHERE
        mrp.maintenance_record_id = #{maintenanceRecordId}
        and mrp.maintenance_member_type = #{maintenanceRecordType}
        and mrp.pay_state=#{payState}
        <if test="null!=workerTypeId and ''!=workerTypeId">
            and mrp.worker_type_id=#{workerTypeId}
        </if>
    </select>
</mapper>