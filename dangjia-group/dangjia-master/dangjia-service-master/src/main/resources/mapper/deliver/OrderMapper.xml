<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.delivery.IOrderMapper">
    <sql id="all_columns">
        id,
        house_id as houseId,
        business_order_number as businessOrderNumber,
        total_amount as totalAmount,
        worker_type_name as workerTypeName,
        worker_type_id as workerTypeId,
        style_name as styleName,
        style_price as stylePrice,
        budget_cost as budgetCost,
        type,
        payment,
        create_date as createDate,
        modify_date as modifyDate,
        data_status as dataStatus
    </sql>

    <!-- 查询工种订单 -->
    <select id="getWorkerOrder" resultType="com.dangjia.acg.modle.deliver.Order">
        SELECT
        <include refid="all_columns"/>
        from dj_deliver_order
        where
            house_id = #{houseId}
        and
            worker_type_id = #{workerTypeId}
        and
            type = 1
        LIMIT 1
    </select>

    <!-- 根据订单号查询订单 -->
    <select id="byBusinessOrderNumber" resultType="com.dangjia.acg.modle.deliver.Order">
        SELECT
        <include refid="all_columns"/>
        from dj_deliver_order
        where
            business_order_number = #{businessOrderNumber}
        ORDER BY create_date desc
    </select>

    <!-- 根据订单号查询订单 -->
    <select id="byBusinessOrderNumberAndOrderStatus" resultType="com.dangjia.acg.modle.deliver.Order">
        SELECT
        <include refid="all_columns"/>
        from dj_deliver_order
        where
        business_order_number = #{businessOrderNumber}
        <if test="orderStatus!=null and orderStatus!=''">
            and orderStatus = #{orderStatus}
        </if>
        ORDER BY create_date desc
    </select>

    <!-- 根据所有的订单 -->
    <select id="getAllOrders" resultType="com.dangjia.acg.modle.deliver.Order">
        SELECT
            house_id houseId,SUM(total_amount) totalAmount,worker_type_id workerTypeId,type
        FROM
            dj_deliver_order
        WHERE
         house_id = #{houseId}
        and
            worker_type_id = #{workerTypeId}
        GROUP BY house_id,worker_type_id,type
        ORDER BY
            create_date DESC
    </select>

    <select id="getOrderInfo" resultType="com.dangjia.acg.modle.deliver.Order">
        SELECT
            id,
            order_number orderNumber,
            order_status orderStatus,
            order_generation_time orderGenerationTime
        FROM
            dj_deliver_order
        WHERE
            house_id = #{houseId}
        AND order_type = '1'
        AND (parent_order_id = '0' or parent_order_id is null)
        limit 1

    </select>

    <select id="getOrderDetailInfoList" resultType="com.dangjia.acg.modle.deliver.OrderItem">
       SELECT
            t1.id,
            t1.order_id orderId,
            t1.storefont_id storefontId,
            t1.product_id productId,
            t1.price price,
            t1.shop_count shopCount,
            t1.total_price totalPrice,
            t1.order_type orderType
        FROM
            dj_deliver_order t,
            dj_deliver_order_item t1
        WHERE
            t.id = t1.order_id
        AND t.house_id = #{houseId}
        AND t.order_type = '1'

    </select>

    <update id="updateOrderDetail" parameterType="com.dangjia.acg.modle.deliver.OrderItem">
        UPDATE dj_deliver_order_item
        SET  product_id = #{productId},
             price = #{price},
             shop_count = #{shopCount},
             total_price = #{totalPrice},
             update_by = #{updateBy},
             modify_date = now()
        WHERE
            id = #{id}
    </update>

    <update id="updateOrder" >
         update dj_deliver_order
         set is_pay_money=1,
         total_amount=(select sum(t.total_price) from dj_deliver_order_item t where t.order_id=#{orderId})
         where id=#{orderId}
    </update>


    <select id="selectDeliverOrderByHouse" resultType="com.dangjia.acg.modle.deliver.Order">
        SELECT
        ddo.id,
        ddo.house_id as houseId,
        ddo.business_order_number as businessOrderNumber,
        ddo.total_amount as totalAmount,
        ddo.member_id as memberId,
        ddo.address_id as addressId,
        ddo.worker_id as workerId,
        ddo.worker_type_name as workerTypeName,
        ddo.worker_type_id as workerTypeId,
        ddo.style_name as styleName,
        ddo.style_price as stylePrice,
        ddo.budget_cost as budgetCost,
        ddo.type,
        ddo.payment,
        ddo.storefont_id as storefrontId,
        ddo.city_id as cityId,
        ddo.total_discount_price as totalDiscountPrice,
        ddo.total_stevedorage_cost as totalStevedorageCost,
        ddo.total_transportation_cost as totalTransportationCost,
        ddo.order_type  as orderType,
        ddo.actual_payment_price as actualPaymentPrice,
        ddo.is_pay_money  as isPayMoney,
        ddo.is_show_order as isShowOrder,
        ddo.order_status as orderStatus,
        ddo.order_generation_time  as orderGenerationTime,
        ddo.order_source as orderSource,
        ddo.create_date as createDate,
        ddo.modify_date as modifyDate,
        ddo.data_status as dataStatus,
        dbs.storefront_name as storefrontName
        from dj_deliver_order ddo left join  dj_basics_storefront dbs on ddo.storefont_id=dbs.id
        where
        ddo.house_id = #{houseId}
        <if test="cityId!=null and cityId!=''">
            and  ddo.city_id = #{cityId}
        </if>
        <if test="orderStatus!=null and orderStatus!=''">
            and  ddo.order_status = #{orderStatus}
        </if>
    </select>

</mapper>

