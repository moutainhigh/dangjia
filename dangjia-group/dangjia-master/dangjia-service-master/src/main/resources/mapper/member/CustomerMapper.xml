<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.member.ICustomerMapper">
    <sql id="all_columns">
		id,
        stage,
        member_id AS memberId,
        user_id AS userId,
        label_id_arr AS labelIdArr,
        curr_record_id AS currRecordId,
        remind_record_id AS remindRecordId,
        create_date AS createDate,
        modify_date AS modifyDate
	</sql>

    <!-- 根据业主id 查询 -->
    <select id="getCustomerByMemberId" parameterType="String" resultType="com.dangjia.acg.modle.member.Customer">
        SELECT
        <include refid="all_columns" />
        FROM dj_member_customer
        WHERE 1=1
        <if test="memberId!=null and memberId!=''">
            and member_id=#{memberId}
        </if>
        ORDER by create_date desc
    </select>

    <!-- 根据业主id 和 stage 查询 -->
    <select id="getCustomerByMemberIdAndStage" parameterType="String" resultType="com.dangjia.acg.modle.member.Customer">
        SELECT
        <include refid="all_columns" />
        FROM dj_member_customer
        WHERE 1=1
        <if test="memberId!=null and memberId!=''">
            and member_id=#{memberId}
        </if>
        <if test="stage >= 0">
            and stage=#{stage}
        </if>
        ORDER by create_date desc
    </select>

    <!--待分配客户-->
    <select id="waitDistribution" parameterType="String" resultType="com.dangjia.acg.dto.sale.client.CustomerIndexDTO">
        SELECT
        m.id, if(m.name is not null,m.nick_name,m.name) as name,
        m.mobile as phone,
        mc.modify_date AS modifyDate,
        mc.create_date AS createDate,
        mc.label_id_arr AS labelIdArr
        FROM dj_member_customer mc
        INNER join dj_member m
        ON mc.member_id=m.id
        WHERE user_id=#{userId}
        AND mc.data_status=0
        AND stage IN(0,1)
        <if test="null!=searchKey and ''!=searchKey">
            AND CONCAT(m.name,m.mobile) like CONCAT('%',#{searchKey},'%')
        </if>
        ORDER by mc.create_date
        <if test="null!=time and ''!=time">
            desc
        </if>
    </select>
    
    <select id="grabSheet" resultType="com.dangjia.acg.dto.sale.store.GrabSheetDTO">
        SELECT
          mc.id as customerId,
          h.id as houseId,
          if(m.name is not null,m.nick_name,m.name) as name,
          h.create_date AS createDate,
          h.visit_state as visitState
        FROM dj_member_customer mc
        INNER  JOIN dj_member m
        on mc.member_id=m.id
        INNER JOIN dj_house h
        on m.id=h.member_id
        where h.visit_state=0
        and store_id=#{storeId}
        order By h.create_date
    </select>
</mapper>

