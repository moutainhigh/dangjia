<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.repair.IMendDeliverMapper">

    <select id="mendDeliverList" resultType="com.dangjia.acg.dto.deliver.SupplierDeliverDTO">
            SELECT
            id,
            number AS number,
            back_time AS createDate,
            total_amount AS totalAmount,
            apply_money AS applyMoney,
            apply_state AS applyState,
            ship_address AS shipAddress,
            supplier_id AS supplierId
            FROM
            dj_repair_mend_deliver
            WHERE
            data_status = 0
            and apply_state IS not NULL
            AND supplier_id=#{supplierId}
            <if test="applyState == 0">
                    and apply_state =0
            </if>
            <if test="applyState != 0">
                AND (apply_state = 1 OR apply_state = 2)
            </if>
            <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
                and modify_date between #{beginDate} and #{endDate}
            </if>
            <if test="shipAddress!=null and shipAddress!=''">
                and ship_address like CONCAT('%',#{shipAddress},'%')
            </if>
            ORDER BY
            create_date DESC
    </select>

    <select id="selectClsd" resultType="com.dangjia.acg.modle.repair.MendDeliver">
        SELECT
        id,
        number AS number,
        create_date AS createDate,
        total_amount AS totalAmount,
        apply_money AS applyMoney,
        apply_state AS applyState,
        ship_address AS shipAddress,
        supplier_id AS supplierId
        FROM
        dj_repair_mend_deliver
        WHERE
        id=#{id}
        <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
                and modify_date between #{beginDate} and #{endDate}
        </if>
        <if test="shipAddress!=null and shipAddress!=''">
                and ship_address like CONCAT('%',#{shipAddress},'%')
        </if>
      </select>

        <!--退货单查看详情-->
        <select id="mendDeliverDetail" resultType="com.dangjia.acg.modle.repair.MendMateriel">
                select
                b.image AS image,
                b.product_id AS productId,
                b.product_name AS productName,
                b.product_sn AS productSn,
                b.cost AS cost,
                b.price AS price,
                b.unit_name AS unitName,
                b.shop_count AS shopCount,
                b.total_price AS totalPrice,
                b.actual_count AS actualCount,
                b.actual_price AS actualPrice
                from dj_repair_mend_deliver a
                inner join dj_repair_mend_materiel b
                on a.id=b.repair_mend_deliver_id
                where a.id=#{id}
        </select>

    <select id="searchReturnRefundSplitCount" resultType="java.lang.Integer">
        SELECT
         count(t.id)
        FROM
            dj_repair_mend_order t,
            dj_member m,
            dj_member_address madress,
            dj_repair_mend_deliver md
        WHERE t.apply_member_id=m.id
        and t.id=md.mend_order_id
        and
        (
        t.house_id = madress.house_id
        OR t.address_id = madress.id
        )
        and t.storefront_id=#{storefrontId}
        <if test="state==1"><!--已分配供应商-->
            and md.shipping_state in(0,4,5)
        </if>
        <if test="state==2"><!--已结束-->
            and md.shipping_state in(1,2,6,7,8)
        </if>
    </select>
      <select id="searchReturnRefundSplitList" resultType="com.dangjia.acg.dto.repair.MendDeliverDTO">
            SELECT
                  t.id mendOrderId,
                  t.number mendOrderNumber,
                  t.create_date createDate,
                  t.apply_member_id memberId,
                  madress.address address,
                  m.`name` memberName,
                  m.mobile memberMobile,
                  md.supplier_id supId,
                  md.supplier_name supName,
                  md.id mendDeliverId,
                  md.number mendDeliverNumber,
                 (case when md.shipping_state=6 then 1 else md.shipping_state end) as state
            FROM
                dj_repair_mend_order t,
                dj_member m,
                dj_member_address madress,
                dj_repair_mend_deliver md
            WHERE t.apply_member_id=m.id
            and t.id=md.mend_order_id
            and
                (
                    t.house_id = madress.house_id
                    OR t.address_id = madress.id
                )
            and t.storefront_id=#{storefrontId}
          <if test="state==2"><!--已分配供应商-->
              and md.shipping_state in(0,4,5)
          </if>
          <if test="state==3"><!--已结束-->
              and md.shipping_state in(1,2,6,7,8)
          </if>
          <if test="likeAddress!=null and likeAddress!=''">
              and (t.number LIKE CONCAT('%',#{likeAddress},'%')
              or madress.address LIKE CONCAT('%',#{likeAddress},'%')
              or md.number like CONCAT('%',#{likeAddress},'%'))
          </if>
          order by t.create_date desc
      </select>

    <!--获取符合条件的数据-->
    <select id="queryRefundJobList" resultType="java.util.Map">
      <![CDATA[
        SELECT
          tt1.id repairMendOrderId,'' mendDeliverId,tt1.total_amount totalAmount,tt1.apply_member_id memberId
        FROM
            dj_repair_mend_order tt1
        WHERE tt1.type =4
        and tt1.state=1
        and tt1.create_date<date_add(now(), interval -(select param_value from dj_config where param_key=#{paramNodeKey}) hour)
        and EXISTS(select 1 from dj_deliver_order_progress p where tt1.id=p.progress_order_id)
        union all
        SELECT
          tt1.id repairMendOrderId,tt2.id mendDeliverId,tt2.total_amount totalAmount,tt1.apply_member_id memberId
        FROM
            dj_repair_mend_order tt1,
            dj_repair_mend_deliver tt2
        WHERE tt1.type in(2,5)
        and tt2.shipping_state = 0
        and tt2.create_date<date_add(now(), interval -(select param_value from dj_config where param_key=#{paramNodeKey}) hour)
        and EXISTS(select 1 from dj_deliver_order_progress p where tt1.id=p.progress_order_id)
        ]]>
    </select>

    <select id="queryRefundDeliverJobList" resultType="java.util.Map">
        <![CDATA[
        SELECT
          tt1.id repairMendOrderId,tt3.id mendDeliverId,tt1.total_amount totalAmount,tt1.apply_member_id memberId,tt2.node_code nodeCode
        FROM
            dj_repair_mend_order tt1,
            dj_deliver_order_progress tt2,
            dj_repair_mend_deliver tt3
        WHERE
           tt3.id = tt2.progress_order_id
        and tt1.id=tt3.mend_order_id
        and tt2.create_date=(select max(t.create_date) from dj_deliver_order_progress t where t.progress_order_id=tt2.progress_order_id)
        and tt2.node_code=#{nodeCode}
        and tt1.type in(2,5)
        and tt2.create_date<date_add(now(), interval -(select param_value from dj_config where param_key=#{paramNodeKey}) hour)

        ]]>
    </select>
</mapper>

