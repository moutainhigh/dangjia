<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.repair.IMendOrderMapper">

    <sql id="all_columns">
		id,
		number,
		change_order_id as changeOrderId,
		image_arr as imageArr,
		business_order_number as businessOrderNumber,
		order_name as orderName,
		house_id as houseId,
		worker_type_id as workerTypeId,
		apply_member_id as applyMemberId,
		type,
		state,
		total_amount as totalAmount,
		carriage,
		data_status as dataStatus,
		create_date as createDate,
		modify_date as modifyDate,
		storefront_id as storefrontId
	</sql>


    <!-- 查询人工单 -->
    <select id="workerMendOrder" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
              <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
        type = #{type}
        and state > 0
        and house_id = #{houseId}
        <if test = "workerTypeId!=null and workerTypeId!=''">
            and
            worker_type_id = #{workerTypeId}
        </if>
        ORDER BY create_date desc
    </select>


    <!-- 查询补退人工单 -->
    <select id="getByChangeOrderId" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
            <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
            type in (1,3)
        and change_order_id = #{changeOrderId}
    </select>

    <!-- 查询工种未处理补人工 -->
    <select id="unCheckRepWorker" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
        type = 1
        AND  house_id = #{houseId}
        and  worker_type_id = #{workerTypeId}
        and state = 1
    </select>

    <!-- 查询工种未处理退人工 -->
    <select id="unCheckBackWorker" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
        type = 3
        AND  house_id = #{houseId}
        and  worker_type_id = #{workerTypeId}
        and state = 1
    </select>

    <!-- 查询退人工单 -->
    <select id="workerBackState" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
            type = 3
        and state > 0
        <if test = "houseId!=null and houseId!=''">
            and
            house_id = #{houseId}
        </if>
        ORDER BY create_date desc
    </select>


    <!-- 查询补人工单 -->
    <select id="workerOrderState" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
        type = 1
        and state > 0
        <if test = "houseId!=null and houseId!=''">
            and
            house_id = #{houseId}
        </if>
        ORDER BY create_date desc
    </select>

    <!-- 查询未处理退人工 -->
    <select id="backWorker" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
        type = 3
        AND  house_id = #{houseId}
        and state = 1
    </select>

    <!-- 查询未处理补人工 -->
    <select id="untreatedWorker" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
            type = 1
        AND  house_id = #{houseId}
        and state = 1
    </select>

    <!-- 查询业主申请退货单 -->
    <select id="landlordState" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
            type = 4
        and state > 0
        <if test = "houseId!=null and houseId!=''">
            and
            house_id = #{houseId}
        </if>
        ORDER BY category_id desc
    </select>

    <!-- 查询退货单 -->
    <select id="materialBackState" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
        type = 2
        and state > 0
        <if test = "houseId!=null and houseId!=''">
            and
            house_id = #{houseId}
        </if>
        ORDER BY create_date desc
    </select>

    <!-- 查询补货单 -->
    <select id="materialOrderState" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
            <include refid="all_columns"/>
        FROM dj_repair_mend_order
        where
            type = 0
        and state > 0
        <if test = "houseId!=null and houseId!=''">
            and
            house_id = #{houseId}
        </if>
        ORDER BY create_date desc
    </select>

    <!-- 按state 和 收货地址 搜索 -->
    <select id="materialByStateAndLikeAddress" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        rmo.id,
        rmo.number,
        rmo.change_order_id as changeOrderId,
        rmo.image_arr as imageArr,
        rmo.business_order_number as businessOrderNumber,
        rmo.order_name as orderName,
        rmo.house_id as houseId,
        rmo.worker_type_id as workerTypeId,
        rmo.apply_member_id as applyMemberId,
        rmo.type,
        rmo.state,
        rmo.total_amount as totalAmount,
        rmo.carriage,
        rmo.data_status as dataStatus,
        rmo.create_date as createDate,
        rmo.modify_date as modifyDate,
        house.id ,
        house.residential as residential,
        house.building as building,
        house.unit as unit,
        house.number as number,
        house.member_id as memberId
        FROM dj_repair_mend_order as rmo
        left  JOIN dj_house as house
        on (rmo.house_id = house.id  )
        where 1=1
        and  rmo.storefront_id = #{storefrontId}
        <if test = "state!=null and state!=''">
            and  rmo.state = #{state}
        </if>
        <if test = "type!=null and type!=''">
            and rmo.type = #{type}
        </if>
        <if test="likeAddress!=null and likeAddress!=''">
            AND (CONCAT(
            house.residential,
            IFNULL(house.building, '*'),
            '栋',
            IFNULL(CONCAT(house.unit, '单元'),'' ),
            IFNULL(house.number, '*'),
            '号'
            )  LIKE CONCAT('%',#{likeAddress},'%') or rmo.number like CONCAT('%',#{likeAddress},'%'))
        </if>
        ORDER BY rmo.create_date desc
    </select>
    <!--店铺退货分发供应商列表-->
    <select id="storeReturnDistributionSupplier" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        rmo.id,
        IFNULL(rmd.number,'') deliverNumber, -- 退货单号
        IFNULL(rmd.supplier_name,'') as supplierName, -- 供应商名称
        rmo.number, -- 订单号
        rmo.change_order_id AS changeOrderId,
        rmo.image_arr AS imageArr, -- 相关凭证
        rmo.business_order_number AS businessOrderNumber,-- 订单号
        rmo.order_name AS orderName, -- 订单描述
        rmo.house_id AS houseId, -- 房间ID
        rmo.worker_type_id AS workerTypeId,-- 工种ID
        rmo.apply_member_id AS applyMemberId,-- 申请人id
        rmo.type,-- 类型：（0:补材料;1:补人工;2:退材料(剩余材料登记);3:退人工,4:业主退材料;5业主退货退款）
        rmo.state,-- 状态：（0生成中,1处理中,2不通过取消,3已通过,4已全部结算,5已撤回,6已关闭）
        rmo.total_amount AS totalAmount, -- 总价
        rmo.carriage, -- 运费
        rmo.data_status AS dataStatus, -- 数据状态
        rmo.create_date AS createDate, -- 创建时间
        rmo.modify_date AS modifyDate, -- 修改时间
        -- house.id as houseId, 房子id
        house.residential AS residential,-- 小区名
        house.building AS building, -- 楼栋，后台客服填写 ,
        house.unit AS unit, -- 单元号，后台客服填写 ,
        --  house.number AS number, 房间号，后台客服填写 ,
        house.member_id AS memberId, -- 用户ID ,
        rmo.storefront_id as storefrontId-- 店铺id
        FROM
        dj_repair_mend_order AS rmo
        LEFT JOIN dj_house AS house ON (rmo.house_id = house.id)
        left join dj_repair_mend_deliver as rmd on rmd.mend_order_id=rmo.id
        WHERE
        1 = 1
        and  rmo.storefront_id = #{storefrontId}
        and  rmo.state in (3,8) -- 部分退货
        and rmo.type in (2,5) -- 工匠申请退货、业主退货退款
        <if test="likeAddress!=null and likeAddress!=''">
            AND (CONCAT(
            house.residential,
            IFNULL(house.building, '*'),
            '栋',
            IFNULL(CONCAT(house.unit, '单元'),'' ),
            IFNULL(house.number, '*'),
            '号'
            )  LIKE CONCAT('%',#{likeAddress},'%') or rmo.number like CONCAT('%',#{likeAddress},'%'))
        </if>
        ORDER BY rmo.create_date desc

    </select>

    <select id="searchReturnRrefundList" resultType="com.dangjia.acg.dto.repair.MendOrderDTO">
        SELECT
            t.id mendOrderId,
            t.number,
            t.create_date createDate,
            t.apply_member_id memberId,
            madress.address address,
            m.`name` memberName,
            m.mobile memberMobile
        FROM
            dj_repair_mend_order t,
          dj_member m,
            dj_member_address madress
        WHERE t.apply_member_id=m.id
        and
            (
                t.house_id = madress.house_id
                OR t.address_id = madress.id
            )
        and t.storefront_id=#{storefrontId}
        <if test="type==1"><!--退货退款-->
           and t.type in(2,5)
        </if>
        <if test="type==2"><!--仅退款-->
           and t.type=4
        </if>
        <if test="state==1"><!--待处理-->
            and t.state=1
        </if>
        <if test="state==2"><!--已处理-->
            and t.state=4
        </if>
        <if test="likeAddress!=null and likeAddress!=''">
            and (t.number LIKE CONCAT('%',#{likeAddress},'%')
            or madress.address LIKE CONCAT('%',#{likeAddress},'%'))
        </if>
        order by t.create_date desc

    </select>

    <!-- 按state 和 收货地址 搜索 -->
    <select id="materialByStateAndLikeAddressHandle" resultType="com.dangjia.acg.modle.repair.MendOrder">
        SELECT
        rmo.id,
        IFNULL(rmd.number,'') deliverNumber, -- 退货单号
        IFNULL(rmd.supplier_name,'') as supplierName, -- 供应商名称
        rmo.number, -- 订单号
        rmo.change_order_id AS changeOrderId,
        rmo.image_arr AS imageArr, -- 相关凭证
        rmo.business_order_number AS businessOrderNumber,-- 订单号
        rmo.order_name AS orderName, -- 订单描述
        rmo.house_id AS houseId, -- 房间ID
        rmo.worker_type_id AS workerTypeId,-- 工种ID
        rmo.apply_member_id AS applyMemberId,-- 申请人id
        rmo.type,-- 类型：（0:补材料;1:补人工;2:退材料(剩余材料登记);3:退人工,4:业主退材料;5业主退货退款）
        rmo.state,-- 状态：（0生成中,1处理中,2不通过取消,3已通过,4已全部结算,5已撤回,6已关闭）
        rmo.total_amount AS totalAmount, -- 总价
        rmo.carriage, -- 运费
        rmo.data_status AS dataStatus, -- 数据状态
        rmo.create_date AS createDate, -- 创建时间
        rmo.modify_date AS modifyDate, -- 修改时间
        -- house.id , 房子id
        house.residential AS residential,-- 小区名
        house.building AS building, -- 楼栋，后台客服填写 ,
        house.unit AS unit, -- 单元号，后台客服填写 ,
        --  house.number AS number,  房间号，后台客服填写 ,
        house.member_id AS memberId, -- 用户ID ,
        rmo.storefront_id as storefrontId-- 店铺id
        FROM
        dj_repair_mend_order AS rmo
        LEFT JOIN dj_house AS house ON (rmo.house_id = house.id)
        left join dj_repair_mend_deliver as rmd on rmd.mend_order_id=rmo.id
        WHERE
        1 = 1
        and  rmo.storefront_id = #{storefrontId}
        <if test = "state==2">
            and  rmo.state in (2,3,4,5,6)
        </if>
        <if test = "type!=null and type!=''">
            and rmo.type = #{type}
        </if>
        <if test="likeAddress!=null and likeAddress!=''">
            AND (CONCAT(
            house.residential,
            IFNULL(house.building, '*'),
            '栋',
            IFNULL(CONCAT(house.unit, '单元'),'' ),
            IFNULL(house.number, '*'),
            '号'
            )  LIKE CONCAT('%',#{likeAddress},'%') or rmo.number like CONCAT('%',#{likeAddress},'%'))
        </if>
        ORDER BY rmo.create_date desc
    </select>

    <select id="querySurplusMaterial" resultType="com.dangjia.acg.dto.repair.SurplusMaterialDTO">
         SELECT
            m. NAME AS NAME,
            m.mobile AS mobile,
            ts.create_date AS createDate,
            rmm.image AS image,
            rmm.product_name AS productName,
            rmm.product_id AS productId,
            rmm.price AS price,
            rmm.unit_name AS unitName,
            dosi.receive AS receive,
            dosi.shop_count AS shopCount,
            rmo.apply_member_id as workerId,
            rmo.house_id as houseId,
            ts.id AS taskStackId,
            rmo.id AS mendOrderId,
            rmm.id AS mendMaterielId,
            dosi.id AS orderSplitItemId,
            dos.id  as orderSplitId,
            dos.storefront_id as storefrontId
        FROM
            dj_task_stack ts
        INNER JOIN dj_repair_mend_order rmo ON rmo.id = ts.data
        INNER JOIN dj_repair_mend_materiel rmm ON rmo.id = rmm.mend_order_id
        INNER JOIN dj_deliver_order_split_item dosi ON dosi.id = rmm.order_item_id
        INNER JOIN dj_deliver_order_split dos ON dos.id = dosi.order_split_id
        INNER JOIN dj_member m ON rmo.apply_member_id = m.id
        WHERE
            rmo.id = #{data}
    </select>

    <select id="queryTrialRetreatMaterial" resultType="com.dangjia.acg.dto.repair.SurplusMaterialDTO">
         SELECT
            bs.storefront_name AS storefrontName,
            bs.mobile AS mobile,
            rmo.business_order_number AS businessOrderNumber,
            rmo.return_reason AS returnReason,
            rmo.id AS mendOrderId,
            rmo.state as state,
            rmo.type as type,
            rmm.product_name AS productName,
            rmm.image AS image,
            rmm.price AS price,
            rmm.unit_name AS unitName,
            rmm.shop_count AS shopCount,
            rmm.actual_count AS actualCount,
            rmm.product_id AS productId,
            rmm.id AS mendMaterielId
        FROM
            dj_repair_mend_order rmo
        INNER JOIN dj_repair_mend_materiel rmm ON rmo.id = rmm.mend_order_id
        INNER JOIN dj_basics_storefront bs ON bs.id = rmo.storefront_id
        WHERE
            rmo.id = #{data}
    </select>

</mapper>

