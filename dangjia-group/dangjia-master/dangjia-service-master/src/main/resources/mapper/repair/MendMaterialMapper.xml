<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.repair.IMendMaterialMapper">

    <sql id="all_columns">
        id,
        mend_order_id as mendOrderId,
        product_id as productId,
        product_sn as productSn,
        product_name as productName,
        product_nick_name as productNickName,
        price,
        cost,
        unit_name as unitName,
        shop_count as shopCount,
        total_price as totalPrice,
        product_type as productType,
        category_id as categoryId,
        image,
	    create_date as createDate,
	    supplier_id as supplierId,
	    supplier_telephone as supplierTelephone,
	    supplier_name as supplierName,
		modify_date as modifyDate
	</sql>


    <!-- 查询房子工种所有补材料 -->
    <select id="askAndQuit"  resultType="com.dangjia.acg.modle.repair.MendMateriel">
        SELECT
        mm.id,
        mm.mend_order_id as mendOrderId,
        mm.product_id as productId,
        mm.product_sn as productSn,
        mm.product_name as productName,
        mm.product_nick_name as productNickName,
        mm.price,
        mm.cost,
        mm.unit_name as unitName,
        mm.shop_count as shopCount,
        mm.total_price as totalPrice,
        mm.product_type as productType,
        mm.category_id as categoryId,
        mm.image,
        mm.create_date as createDate,
        mm.modify_date as modifyDate
        FROM dj_repair_mend_order mo, dj_repair_mend_materiel mm
        where
        mo.house_id = #{houseId}
        and mo.worker_type_id = #{workerTypeId}
        and mo.type = 0
        and mo.state = 4
        and mm.mend_order_id = mo.id
        <if test = "name!=null and name!=''">
            and
            mm.product_name LIKE CONCAT('%',#{name},'%')
        </if>
        <if test = "categoryId!=null and categoryId!=''">
            and
            mm.category_id = #{categoryId}
        </if>

        ORDER BY mo.create_date desc
    </select>

    <!-- 根据mendOrderId查询所有 -->
    <select id="byMendOrderId" parameterType="java.lang.String" resultType="com.dangjia.acg.modle.repair.MendMateriel">
        SELECT
            drmm.id,
            IFNULL(drmm.mend_order_id,'') as mendOrderId,
            IFNULL(drmm.product_id,'')  as productId,
            IFNULL(drmm.product_sn,'')  as productSn,
            IFNULL(drmm.product_name,'')  as productName,
            IFNULL(drmm.product_nick_name,'')  as productNickName,
            drmm.price,
            drmm.cost,
            IFNULL(drmm.unit_name,'')  as unitName,
            IFNULL(drmm.shop_count,'') as shopCount,
            IFNULL(drmm.total_price,'')  as totalPrice,
            IFNULL(drmm.product_type,'')  as productType,
            IFNULL(drmm.category_id,'')  as categoryId,
            IFNULL(drmm.image,'') as image,
            IFNULL(drmm.create_date,'')  as createDate,
            IFNULL(drmm.supplier_id,'')  as supplierId,
            IFNULL(drmm.supplier_telephone,'')  as supplierTelephone,
            IFNULL(drmm.supplier_name,'')  as supplierName,
            IFNULL(drmm.modify_date,'')  as modifyDate,
            IFNULL(drmm.actual_count,'') as actualCount,
			IFNULL(ds.is_non_platform_supplier,'0') as isNonPlatformSupplier
        FROM dj_repair_mend_materiel drmm
        left join dj_supplier ds on drmm.supplier_id=ds.id
        where
        drmm.mend_order_id = #{mendOrderId}
        ORDER BY drmm.category_id, drmm.create_date desc
    </select>

    <!-- 根据mendOrderId查询所有 -->
    <select id="getMendOrderGoods" parameterType="java.lang.String" resultType="com.dangjia.acg.modle.repair.MendMateriel">
        SELECT
        <include refid="all_columns"/>
        FROM dj_repair_mend_materiel
        where
        mend_order_id = #{mendOrderId} and product_id=#{productId}
        LIMIT 1
    </select>


    <select id="getWarehouseGoods" parameterType="java.lang.String" resultType="com.dangjia.acg.dto.house.WarehouseGoodsDTO">
       SELECT
            orderId,
            type,
            number,
            createDate,
            state
        FROM
            (
                (
                SELECT
                    o.id orderId,
                    o.type,
                    o.house_id,
                    o.number,
                    o.create_date createDate,
                    o.state
                FROM
                    dj_repair_mend_order o
                    INNER JOIN dj_repair_mend_materiel m ON o.id = m.mend_order_id
                WHERE
                    m.product_id =#{productId} and  o.house_id= #{houseId} and o.state!=0
                GROUP BY
                    o.id
                ) UNION ALL
                (
                SELECT
                    o.id orderId,
                    '7' type,
                    o.house_id,
                    o.number,
                    o.create_date createDate,
                    o.shipping_state state
                FROM
                    dj_deliver_split_deliver o
                    INNER JOIN dj_deliver_order_split_item m ON o.id = m.split_deliver_id
                WHERE
                    m.product_id = #{productId} and  o.house_id= #{houseId}
                GROUP BY
                    o.id
                )
            ) a
        ORDER BY
            a.createDate DESC
    </select>

    <select id="getWarehouseWorker" parameterType="java.lang.String" resultType="com.dangjia.acg.dto.house.WarehouseGoodsDTO">
       SELECT
			o.id orderId,
			o.type,
			o.house_id,
			o.number,
			o.create_date createDate,
			o.state
        FROM dj_repair_mend_order o
        INNER JOIN dj_repair_mend_worker m ON o.id = m.mend_order_id
        WHERE
                m.worker_goods_id =#{productId} and  o.house_id= #{houseId}
        GROUP BY
                o.id
    </select>

    <update id="setStorefrontId">
        UPDATE dj_repair_mend_materiel a
        INNER JOIN dj_basics_storefront_product b ON a.product_id = b.id
        SET a.storefront_id = b.storefront_id
        WHERE
            a.mend_order_id = #{mendOrderId}
    </update>


    <select id="queryMendMaterielProgress" resultType="com.dangjia.acg.dto.repair.ReturnOrderProgressDTO">
        SELECT
          t1.id,
          t1.create_date createDate,
          t1.progress_order_id progressOrderId,
          t1.progress_type progressType,
          t2.`code` nodeCode,
          t2.`name` nodeName,
          t2.`describe` nodeDescribe,
          t2.associated_operation associatedOperation,
          t2.associated_operation_name  associatedOperationName
        FROM
            dj_deliver_order_progress t1,
            dj_deliver_order_node t2
        WHERE
            t1.progress_order_id =#{progressOrderId}
        AND t1.node_type = t2.type
        AND t1.node_code = t2.`code`
        and t1.data_status = 0
        order by t1.create_date,t2.code
    </select>
</mapper>

