<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.product.IBasicsGoodsCategoryMapper">

    <sql id="all_columns">
        id,
        NAME,
        parent_id AS parentId,
        parent_top AS parentTop,
        image,
        create_date AS createDate,
        modify_date AS modifyDate,
        is_last_category AS isLastCategory,
        purchase_restrictions AS purchaseRestrictions,
        cover_image AS coverImage,
        category_label_ids categoryLabelId
	</sql>
    <!-- 删除对象 -->
    <delete id="deleteById" parameterType="java.lang.String">
		DELETE FROM dj_basics_goods_category 
		WHERE id=#{id}
	</delete>
    <!-- 查询所有 -->
    <select id="query" resultType="com.dangjia.acg.modle.product.BasicsGoodsCategory">
		SELECT
            id,
            NAME,
            parent_id AS parentId,
            parent_top AS parentTop,
            image,
            create_date AS createDate,
            modify_date AS modifyDate,
            is_last_category AS isLastCategory,
            purchase_restrictions AS purchaseRestrictions,
            cover_image AS coverImage,
            category_label_ids categoryLabelId
		FROM dj_basics_goods_category
	</select>

    <!-- 根据父id查询下属商品类别 -->
    <select id="queryCategoryByParentId" resultType="com.dangjia.acg.modle.product.BasicsGoodsCategory">
        SELECT
        <include refid="all_columns"/>
        FROM dj_basics_goods_category where parent_id =#{parentId}
        <if test="categoryLabelId!=null and categoryLabelId!=''">
            and FIND_IN_SET(#{categoryLabelId},category_label_ids)
        </if>
        ORDER BY create_date desc
    </select>

    <!-- 根据父id查询下属商品类别 -->
    <select id="queryCategoryByName" resultType="com.dangjia.acg.modle.product.BasicsGoodsCategory">
        SELECT
        <include refid="all_columns"/>
        FROM dj_basics_goods_category where name =#{name}
        ORDER BY create_date desc
    </select>
    <select id="getProductList" resultType="com.dangjia.acg.modle.basics.HomeProductDTO">
        SELECT
            p.id AS id,
            p.image AS image,
            p.price AS price,
            u. NAME AS unitName,
            g.type AS goodsType,
            0 AS type,
            p. NAME AS NAME
            FROM
            dj_basics_product p,
            dj_basics_product_material p1,
            dj_basics_goods_category c,
            dj_basics_goods g,
            dj_basics_unit u
        WHERE
        p.id = p1.product_id
        AND c.id = p.category_id
        AND p.goods_id=g.id
        and g.category_id=c.id
        AND u.id = p1.convert_unit
        AND p.maket = 1
        AND p.type = 1
        and p.maket = 1
        AND p.type = 1
        <if test="categoryId!=null and categoryId!=''">
            AND c.parent_top = #{categoryId}
        </if>
        ORDER BY p.istop DESC,
        p.create_date DESC
    </select>

    <!-- 删除商品和系列关系 -->
    <delete id="deleteCategorysSeries" parameterType="java.lang.String">
		DELETE FROM dj_basics_category_brand
		WHERE category_id=#{categoryId}
	</delete>

    <!-- 根据商品id查询关联品牌 -->
    <select id="queryBrandByCategoryid" resultType="com.dangjia.acg.modle.brand.Brand">
		SELECT
			id,
			name,
			create_date as createDate,
			modify_date as modifyDate
		FROM dj_basics_brand
		where
		     id in(
		        select
		              brand_id
		        from dj_basics_category_brand
		        where
		             category_id =#{categoryId}
		        group by brand_id
		     )
		ORDER BY create_date desc
	</select>

    <!-- 根据商分类顶级id查询关联品牌 -->
    <select id="queryBrandByTopCategoryid" resultType="com.dangjia.acg.modle.brand.Brand">
        SELECT
        b.id,
        b.NAME,
        b.create_date AS createDate,
        b.modify_date AS modifyDate
        FROM
        dj_basics_brand b
        INNER JOIN dj_basics_product p ON (p.`name` LIKE CONCAT('%', b. NAME, '%'))
        INNER JOIN dj_basics_goods_category c ON c.id = p.category_id
        WHERE p.maket = 1 AND p.type = 1
        <if test="wordKey!=null and wordKey!=''">
            AND p.`name` LIKE CONCAT('%',#{wordKey},'%')
        </if>
        <if test="categoryId!=null and categoryId!=''">
            AND (c.id = #{categoryId} OR c.parent_top = #{categoryId})
        </if>
        GROUP BY b.id
        ORDER BY
        c.sort DESC
    </select>

    <!-- 查询当前顶级分类下的与有类别-->
    <select id="getAllCategoryChildById" resultType="com.dangjia.acg.modle.product.BasicsGoodsCategory">
        SELECT
        *
        FROM
        (
        SELECT
        T1.*,
        IF (
        FIND_IN_SET(parentTop, @PIDS) > 0,
        @PIDS := CONCAT(@PIDS, ',', T1.ID),
        0
        ) AS ISCHILD
        FROM
        (
        SELECT
        <include refid="all_columns"/>
        FROM
        dj_basics_goods_category A
        ) AS T1,
        (
        SELECT
        @PIDS := #{parentTop}
        ) t2
        ) t3
        WHERE
        ISCHILD != '0'
    </select>


</mapper>