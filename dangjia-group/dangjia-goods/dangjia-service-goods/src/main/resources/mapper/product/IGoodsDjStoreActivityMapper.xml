<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dangjia.acg.mapper.product.IGoodsDjStoreActivityMapper">

    <select id="querySpellDeals" resultType="java.util.Map">
        SELECT
            a.id AS orderId,
            a.order_generation_time AS orderGenerationTime,
            c.head,
            (
                b.spell_group - (
                    SELECT
                        COUNT(0)+1
                    FROM
                        dj_deliver_order d
                    WHERE
                        d.store_activity_id IS NOT NULL
                    AND d.order_source = 6
                    AND d.order_status = 9
                    AND d.parent_order_id = a.id
                    AND d.store_activity_product_id = #{storeActivityProductId}
                )
            ) AS shortPeople
        FROM
            dj_deliver_order a
        INNER JOIN dj_store_activity b ON a.store_activity_id = b.id
        INNER JOIN dj_member c ON a.member_id = c.id
        WHERE
            a.store_activity_id IS NOT NULL
        AND a.order_source = 6
        AND a.order_status = 9
        AND parent_order_id IS NULL
        AND a.store_activity_product_id = #{storeActivityProductId}
    </select>
</mapper>