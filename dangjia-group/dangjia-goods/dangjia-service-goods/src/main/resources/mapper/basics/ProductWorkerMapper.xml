<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dangjia.acg.mapper.basics.IProductWorkerMapper">
    <!--每工种未删除 或 已支付工钱-->
    <select id="getWorkertoCheck" resultType="java.lang.Double">
        select sum(wg.price*abw.shop_count)
        from dj_actuary_budget_material abw
        where abw.data_status = 0
        and abw.house_id=#{houseId}
        and abw.delete_state!=1
        and abw.delete_state!=2
        and abw.house_flow_id=#{houseFlowId}
    </select>
    <!--从精算表查每工种已支付工钱-->
    <select id="getPayedWorker" resultType="java.lang.Double">
        select sum(abw.price*abw.shop_count)
        from dj_actuary_budget_material abw
        where abw.data_status = 0
        and abw.product_type=2
        and abw.house_id=#{houseId}
        and abw.delete_state =3
        and abw.house_flow_id=#{houseFlowId}
    </select>
    <!-- 从精算表查代购商品支付工钱 -->
    <select id="getAgencyPurchaseMoney" resultType="java.lang.Double">
       SELECT
            sum(t.total_price)
        FROM
            dj_actuary_budget_material t,dj_basics_storefront_product t1, dj_basics_product_template t2
        WHERE t.product_id = t1.id
        and t1.prod_template_id=t2.id
        and t.house_id = #{houseId}
        AND t.house_flow_id = #{houseFlowId}
        AND t2.is_agency_purchase = 1
        AND t.delete_state = 3
    </select>

    <select id="getProductWorker" resultType="com.dangjia.acg.dto.product.ProductWorkerDTO">
        SELECT
            t.id AS id,
            t.NAME AS NAME,
            t.goods_id AS goodsId,
            t.category_id AS categoryId,
            t.product_sn AS productSn,
            t.image AS image,
            t.unit_id AS unitId,
            t.label_id AS labelId,
            t.unit_name AS unitName,
            t.type AS type,
            t.istop,
            t.price AS price,
            t.other_name AS otherName,
            t.create_date AS createDate,
            t.modify_date AS modifyDate,
            t.work_explain AS workExplain,
            t.worker_dec AS workerDec,
            t.worker_standard AS workerStandard,
            t.worker_type_id AS workerTypeId,
            t.last_price AS lastPrice,
            t.last_time AS lastTime,
            t.technology_ids AS technologyIds,
            t.considerations,
            t.calculate_content calculateContent,
            t.build_content buildContent,
            t.is_agency_purchase isAgencyPurchase
        FROM
            dj_basics_product_template t
        WHERE t.maket = 1
        AND t.worker_type_id = #{workerTypeId}
        and t.city_id=#{cityId}
        <if test="name!=null and name!=''">
            AND t.`name` LIKE CONCAT('%', #{name}, '%')
        </if>

    </select>

    <!--更新单位-->
    <update id="updateWorkerGoodsByUnitId" parameterType="java.lang.String">
        update dj_basics_product
        set unit_name=#{unitName}
        where unit_id=#{unitId}
    </update>
    <select id="getHomeProductList" resultType="com.dangjia.acg.modle.basics.HomeProductDTO">
      SELECT
            p.id AS id,
            p.image AS image,
            p.sell_price AS price,
            t.unit_name AS unitName,
            g.type AS goodsType,
            g.type AS type,
            p.product_name AS NAME
            FROM
                dj_basics_storefront_product  p
                INNER JOIN dj_basics_product_template t on p.prod_template_id=t.id
                INNER JOIN dj_basics_goods g ON g.id = p.goods_id
            WHERE
                p.data_status = 0
                AND t.type = 1
                AND p.is_shelf_status = 1
                AND t.image !='qrcode/moren.png'
            ORDER BY
                rand( )
                LIMIT 6
    </select>
</mapper>