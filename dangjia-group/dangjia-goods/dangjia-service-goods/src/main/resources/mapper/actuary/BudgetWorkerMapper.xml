<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangjia.acg.mapper.actuary.IBudgetWorkerMapper">

	<sql id="all_columns">
	   	id,
		house_flow_id as houseFlowId,
		house_id as houseId,
		worker_type_id as workerTypeId,
		steta,
		template_id as templateId,
		delete_state as deleteState,
		worker_goods_id as workerGoodsId,
		worker_goods_sn as workerGoodsSn,
		name,
		image,
		price,
		description,
		shop_count as shopCount,
		repair_count as repairCount,
		back_count as backCount,
		unit_name as unitName,
		total_price as totalPrice,
		data_status as dataStatus,
		create_date as createDate,
		modify_date as modifyDate
	</sql>

	<sql id="new_columns">
		id,
		house_flow_id as houseFlowId,
		house_id as houseId,
		worker_type_id as workerTypeId,
		steta,
		template_id as templateId,
		convert_count as convertCount,
		delete_state as deleteState,
		product_id as productId,
		product_sn as productSn,
		product_name as productName,
		product_nick_name as productNickName,
		goods_id as goodsId,
		goods_name as goodsName,
		price,
		cost,
		description,
		shop_count as shopCount,
		unit_name as unitName,
		total_price as totalPrice,
		group_type as groupType,
		product_type as productType,
		goods_group_id as goodsGroupId,
		category_id as categoryId,
		repair_count as repairCount,
		back_count as backCount,
		image,
		create_date as createDate,
		modify_date as modifyDate
	</sql>
	<!--精算工种人工(支付和未支付)-->
	<select id="getTypeAllList" resultType="com.dangjia.acg.modle.actuary.BudgetMaterial">
		SELECT
		<include refid="new_columns"/>
		FROM dj_actuary_budget_material
		WHERE product_type='2'
		and house_id=#{houseId}
		<if test = "workerTypeId!=null and workerTypeId!=''">
			and worker_type_id =#{workerTypeId}
		</if>
		<if test = "deleteState!=null and deleteState!=''">
			and delete_state = #{deleteState}
		</if>
		<if test = "deleteState==null or deleteState==''">
			and delete_state in (0,2,3);
		</if>

	</select>

	<!--精算工种人工总价(支付和未支付)-->
	<select id="getTypeAllPrice" resultType="java.lang.Double">
		SELECT
			IFNULL(sum(bw.price * bw.shop_count),0) workerPrice
		FROM
		dj_actuary_budget_material bw
		WHERE  bw.house_id = #{houseId}
		and bw.product_type='2'
		<if test = "deleteState!=null and deleteState!=''">
			and bw.delete_state = #{deleteState}
		</if>
		<if test = "deleteState==null or deleteState==''">
			and bw.delete_state in (0,2,3)
		</if>
	    and bw.worker_type_id = #{workerTypeId}
	</select>

	<!--房子人工总价-->
	<select id="getHouseWorkerPrice" resultType="java.lang.Double">
		SELECT
			IFNULL(sum(bw.price * bw.shop_count),0) workerPrice
		FROM dj_actuary_budget_worker bw
		WHERE  bw.house_id = #{houseId}
		<if test = "deleteState!=null and deleteState!=''">
			and bw.delete_state = #{deleteState}
		</if>
		<if test = "deleteState==null or deleteState==''">
			and bw.delete_state in (0,2,3);
		</if>
	</select>

	<!--查询精算工种-->
	<select id="workerTypeList" resultType="java.lang.String">
		select DISTINCT bw.worker_type_id
		from dj_actuary_budget_material bw
 		where bw.house_id = #{houseId}
 		and bw.delete_state in (0,2,3)
 		order by bw.worker_type_id
	</select>

	<select id="byWorkerGoodsId" resultType="com.dangjia.acg.modle.actuary.BudgetMaterial" >
		SELECT
		    <include refid="new_columns"/>
		FROM dj_actuary_budget_material
		WHERE product_type='2'
		and worker_goods_id=#{workerGoodsId}
		and
			house_id=#{houseId}
	</select>

	<!--根据houseFlowId-->
	<select id="getByHouseFlowId" resultType="com.dangjia.acg.modle.actuary.BudgetMaterial">
		SELECT
		<include refid="new_columns"/>
		FROM dj_actuary_budget_material
		WHERE product_type='2'
		and house_id=#{houseId}
		and house_flow_id = #{houseFlowId}
		and delete_state = 3;
	</select>
	<!--根据houseFlowId-->
	<select id="getByHouseFlowTechnologyId" resultType="com.dangjia.acg.modle.basics.Technology">

SELECT
			y.id,
			y.NAME,
			y.material_or_worker AS materialOrWorker,
			y.worker_type_id AS workerTypeId,
			y.content,
			y.type,
			y.image,
			y.goods_id AS goodsId,
			y.sample_image AS sampleImage,
			y.create_date,
			y.modify_date,
			y.considerations,
			y.text_content AS textContent
		FROM
			dj_actuary_budget_material w
      INNER JOIN dj_basics_storefront_product g on w.product_id = g.id
      INNER JOIN dj_basics_product_template t1 on g.prod_template_id=t1.id
			INNER JOIN dj_basics_technology y ON FIND_IN_SET( y.id, t1.technology_ids )
		WHERE
		    w.house_id=#{houseId}
			AND w.house_flow_id = #{houseFlowId}
            and w.product_type='2'
			AND w.delete_state = 3
			AND ( w.shop_count + w.repair_count ) > 0
			AND y.type IN ( 2, 3 )
		GROUP BY
			y.id
	</select>
	<!--支付时工种人工总价-->
	<select id="getBudgetWorkerPrice" resultType="java.lang.Double">
		SELECT
			IFNULL(sum(bw.price * bw.shop_count),0) workerPrice
		FROM
			dj_actuary_budget_material bw
		WHERE  bw.house_id = #{houseId}
		and product_type='2'
	    and bw.delete_state = 0
	    and bw.worker_type_id = #{workerTypeId}
	</select>

	<select id="getBudgetWorkerList" resultType="com.dangjia.acg.modle.actuary.BudgetMaterial">
		SELECT
		<include refid="new_columns"/>
		FROM dj_actuary_budget_material
		WHERE
		   house_id=#{houseId}
		   and product_type='2'
		   and worker_type_id =#{workerTypeId}
		   and delete_state=0;
	</select>

	<!-- 查询所有 -->
	<select id="getBudgetWorker" resultType="java.util.Map">
		SELECT
		     <include refid="all_columns"/>
		FROM dj_actuary_budget_material where product_type='2' ORDER BY create_date desc
	</select>

	<!-- 根据houseId和wokerTypeId查询房子人工精算 -->
	<select id="getBudgetWorkerById" resultType="java.util.Map">
		SELECT
			t1.id,
			t2.prod_template_id prodTemplateId,
			t1.house_flow_id AS houseFlowId,
			t1.house_id AS houseId,
			t1.worker_type_id AS workerTypeId,
			t1.steta,
			t1.template_id AS templateId,
			t1.delete_state AS deleteState,
			t1.product_id AS workerGoodsId,
			t1.product_sn AS workerGoodsSn,
			t1.product_name NAME,
			t1.product_name productName,
			t1.image,
			t1.price,
			t1.description,
			t1.shop_count AS shopCount,
			t1.repair_count AS repairCount,
			t1.back_count AS backCount,
			t1.unit_name AS unitName,
			t1.total_price AS totalPrice,
			t1.data_status AS dataStatus,
			t1.create_date AS createDate,
			t1.modify_date AS modifyDate,
			t4.id goodsId,
			t4.NAME goodsName,
			t4.type productType
		FROM
			dj_actuary_budget_material t1,
			dj_basics_storefront_product t2,
			dj_basics_product_template t3,
			dj_basics_goods t4
		WHERE
			t1.product_id = t2.id
		and t1.product_type='2'
		AND t2.prod_template_id = t3.id
		AND t3.goods_id = t4.id
		and t1.house_id=#{houseId}
		and t1.worker_type_id =#{workerTypeId}
		and t1.delete_state!=1
		ORDER BY t1.product_sn and t1.create_date desc
	</select>

	<!-- 根据houseId和wokerTypeId查询房子人工精算 -->
	<select id="getBudgetWorkerByHouseIdAndWorkerTypeId" resultType="com.dangjia.acg.modle.actuary.BudgetMaterial">
		SELECT
		<include refid="new_columns"/>
		FROM dj_actuary_budget_material
		WHERE house_id=#{houseId}
		and product_type='2'
		and worker_type_id =#{workerTypeId}
		ORDER BY create_date desc
	</select>

	<!-- 根据template_id查询所有 -->
	<select id="getAllbudgetTemplates" resultType="java.util.Map">
		SELECT
		    <include refid="all_columns"/>
		FROM dj_actuary_budget_material WHERE product_type='2' template_id=#{template_id} and steta=3  ORDER BY create_date desc
	</select>

	<!-- 删除对象 -->
	<delete id="deleteById" parameterType="java.lang.String">
		DELETE FROM dj_actuary_budget_material
		WHERE id=#{id}
	</delete>

	<!-- 删除对象 -->
	<delete id="deleteBytemplateId" parameterType="java.lang.String">
		DELETE FROM dj_actuary_budget_material
		WHERE template_id=#{template_id}
		and product_type='2'
	</delete>

	<!-- 根据houseId和工种id删除人工精算 -->
	<delete id="deleteByhouseId" parameterType="java.lang.String">
		DELETE FROM dj_actuary_budget_material
		WHERE house_id=#{houseId}
		and product_type='2'
		and worker_type_id =#{workerTypeId}
	</delete>

	<!-- 根据房子id和工序id查询人工精算总价 -->
	<select id="getWorkerTotalPrice" resultType="java.util.Map">
		SELECT
			 IFNULL(sum(abw.price * abw.shop_count),0) AS totalPrice
		FROM
			dj_actuary_budget_material abw
		WHERE
			abw.house_id = #{houseId}
		and abw.product_type='2'
		AND abw.delete_state != 1
		AND abw.worker_type_id = #{workerTypeId}
    </select>

	<!--<insert id="insertByBatch" parameterType="java.util.List">
		INSERT INTO dj_actuary_budget_worker (
		id,
		house_flow_id,
		house_id,
		worker_type_id,
		steta,
		template_id,
		delete_state,
		worker_goods_id,
		worker_goods_sn,
		image,
		name,
		price,
		description,
		shop_count,
		repair_count,
		back_count,
		unit_name,
		total_price,
		create_date,
		modify_date,
		data_status
		)
		VALUES

		<foreach collection="list" item="item" index="index" separator=",">
			(
			#{item.id},
			#{item.houseFlowId},
			#{item.houseId},
			#{item.workerTypeId},
			#{item.steta},
			#{item.templateId},
			#{item.deleteState},
			#{item.workerGoodsId},
			#{item.workerGoodsSn},
			#{item.image},
			#{item.name},
			#{item.price},
			#{item.description},
			#{item.shopCount},
			#{item.repairCount},
			#{item.backCount},
			#{item.unitName},
			#{item.totalPrice},
			#{item.createDate},
			#{item.modifyDate},
			#{item.dataStatus}
			)
		</foreach>
	</insert>
-->
	<!--&lt;!&ndash;更新人工商品名称&ndash;&gt;
	<update id="updateBudgetMaterialById" parameterType="java.lang.String">
		UPDATE dj_actuary_budget_worker p1
		INNER JOIN `dj_basics_product` p ON p.id = p1.worker_goods_id
		SET p1.name = p.`name`,p1.image=p.image,p1.price=p.price,p1.unit_name=p.unit_name
		WHERE p.id=#{id}
	</update>

	&lt;!&ndash;更新人工商品名称商品3.0改版后调用&ndash;&gt;
	<update id="updateBudgetMaterialByProductId" parameterType="java.lang.String">
		UPDATE dj_actuary_budget_worker p1
		INNER JOIN `dj_basics_product` p ON p.id = p1.worker_goods_id
		SET p1.name = p.`name`,p1.image=p.image,p1.price=p.price,p1.unit_name=p.unit_name
		WHERE p.id=#{id}
	</update>
-->


    <!-- 根据房子id和工序id查询人工精算总价 -->
    <select id="queryMakeBudgetsList" resultType="com.dangjia.acg.dto.product.BasicsgDTO">
        select
            bgc.id as bgcId,
            bp.id as bpId,
            bg.id as bgId,
            bg.buy as buy,
            abw.id as abwId,
            bgc.name as name,
            abw.price as price,
            abw.image as image,
            abw.unit_name as unitName,
            abw.total_price as totalPrice,
            abw.house_id AS houseId,
            abw.steta AS steta,
            abw.worker_goods_id AS workerGoodsId,
            abw.worker_goods_sn AS workerGoodsSn
        from dj_basics_goods_category bgc
        INNER JOIN dj_basics_product bp on bgc.id = bp.category_id
        INNER JOIN dj_actuary_budget_worker abw on bp.id = abw.worker_goods_id
        INNER JOIN dj_basics_goods bg on bg.id = bp.goods_id
        where abw.data_status = 0 and abw.house_id = #{houseId} and bgc.id = #{id}
    </select>

    <!-- 根据房子id和工序id查询人工精算总价 -->
    <select id="queryMakeBudgetsBmList" resultType="com.dangjia.acg.dto.product.BasicsgDTO">
        select
            bg.id as bgId,
            bg.buy as buy,
            bgc.id as bgcId,
            abm.id as abmId,
            abm.goods_name as name,
            abm.product_name as productName,
            abm.price as price,
            abm.cost as cost,
            abm.shop_count AS shopCount,
            abm.convert_count AS convertCount,
            abm.unit_name AS unitName,
            abm.image AS image,
            abm.category_id AS categoryId,
            abm.product_id AS bpId
        from  dj_basics_goods_category bgc
        INNER JOIN dj_basics_goods bg on bg.category_id = bgc.id
        INNER JOIN dj_actuary_budget_material abm on bgc.id = abm.category_id
        and abm.goods_id = bg.id
		where abm.data_status = 0 AND abm.house_id = #{houseId} and bgc.id = #{id}
    </select>



	<!-- 根据houseId和wokerTypeId查询房子人工和房子所有的精算 -->
	<select id="getAllBudgetMaterialWorkerList" resultType="java.util.Map">
		(
			SELECT
				t1.prod_template_id productId,
				t1.prod_template_id productTemplateId,
				t.goods_id goodsId,
				t.product_sn productSn,
				t.product_name productName,
				t.goods_name goodsName,
				t.shop_count shopCount,
				t.storefont_id storefontId,
				t.category_id categoryId
			FROM
				dj_actuary_budget_material t,
				dj_basics_storefront_product t1
			WHERE
				t.product_id = t1.id
			AND t.house_id = #{houseId}
			AND t.worker_type_id = #{workerTypeId}
			and t.delete_state!=1
		)
		UNION ALL
		(
			SELECT
				t1.prod_template_id productId,
				t1.prod_template_id productTemplateId,
				t2.goods_id goodsId,
				t.worker_goods_sn productSn,
				t2.`name` productName,
				t3. NAME goodsName,
				t.shop_count shopCount,
				t.storefont_id storefontId,
				t2.category_id categoryId
			FROM
				dj_actuary_budget_worker t,
				dj_basics_storefront_product t1,
				dj_basics_product_template t2,
				dj_basics_goods t3
			WHERE
				t.worker_goods_id = t1.id
			AND t1.prod_template_id = t2.id
			AND t2.goods_id = t3.id
			AND t.house_id = #{houseId}
			AND t.worker_type_id = #{workerTypeId}
			and t.delete_state!=1
		)
	</select>



	<!--按店铺汇总的设计精算阶段的商品总价钱-->
	<select id="getHouseDetailInfoList" resultType="java.util.Map">
		(
			SELECT
				t.storefont_id storefrontId,
				t1.storefront_name storefrontName,
				sum(t.total_price) totalPrice
			FROM
				dj_actuary_budget_material t
			LEFT JOIN dj_basics_storefront t1 ON t.storefont_id = t1.id
			WHERE
				t.house_id = #{houseId}
			AND t.worker_type_id IN (1, 2)
			AND t.delete_state != 1
			GROUP BY
				t.storefont_id,
			t1.storefront_name
		)
		UNION ALL
			(
				SELECT
					t.storefont_id storefrontId,
					t1.storefront_name storefrontName,
					sum(t.total_price) totalPrice
				FROM
					dj_actuary_budget_worker t
				LEFT JOIN dj_basics_storefront t1 ON t.storefont_id = t1.id
				WHERE
					t.house_id = #{houseId}
				AND t.worker_type_id IN (1, 2)
				AND t.delete_state != 1
				GROUP BY
					t.storefont_id,
			  t1.storefront_name
			)
	</select>

	<!--店铺下面的商品详情信息-->
	<select id="getBudgetProductList" resultType="com.dangjia.acg.dto.actuary.app.ActuarialProductAppDTO">
		SELECT
			t2.id productId,
			t2.storefront_id storefrontId,
			t3.id productTemplateId,
			t3.product_sn productSn,
			t2.product_name productName,
			t3.goods_id goodsId,
			t5.price price,
			t3.image,
			t3.unit_id unit,
			t3.unit_name unitName,
			t3.value_id_arr valueIdArr,
			t3.value_name_arr valueNameArr,
			t4.brand_id brandId
		FROM
			dj_actuarial_product_config t1,
			dj_basics_storefront_product t2,
			dj_basics_product_template t3,
			dj_basics_goods t4,
			(
				(
					SELECT
						t.product_id productId,
						t.storefont_id storefrontId,
						t.price
					FROM
						dj_actuary_budget_material t
					WHERE
						t.house_id = #{houseId}
					AND t.storefont_id = #{storefrontId}
					AND t.worker_type_id IN (1, 2)
					AND t.delete_state != 1
				)
				UNION ALL
					(
						SELECT
							t.worker_goods_id productId,
							t.storefont_id storefrontId,
							t.price
						FROM
							dj_actuary_budget_worker t
						WHERE
							t.house_id = #{houseId}
						AND t.storefont_id = #{storefrontId}
						AND t.worker_type_id IN (1, 2)
						AND t.delete_state != 1
					)
			) t5
		WHERE
			t1.product_id = t2.prod_template_id
		AND t1.product_id = t3.id
		AND t3.goods_id = t4.id
		AND t2.is_shelf_status = 1
		AND t2.id = t5.productId
	</select>

</mapper>
